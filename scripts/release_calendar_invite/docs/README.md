# リリース日カレンダー招待自動化ツール

## 概要

NotionのリリースDBでリリース日プロパティに日付が入力されたら、そのリリースに紐づく全社共通Issueと全社共通Taskの担当者を取得し、プロダクトのスクラムマスター、実装タスクの担当者をGoogleカレンダーに招待するGoogle Apps Script (GAS) スクリプトです。

また、リリース日が変更になった場合は、作成したイベントの日付を自動的に更新します。

## 機能

- **自動イベント作成**: リリース日が入力されたら、関連する全員を招待したカレンダーイベントを自動作成
- **自動日付更新**: リリース日が変更されたら、既存のイベントの日付を自動更新
- **担当者自動抽出**: 
  - プロダクトのスクラムマスター
  - 全社共通Issueに紐づく全社共通Taskの担当者
- **重複防止**: 同一リリースに対して複数回イベントが作成されないように制御

## 実行タイミング

- **定期実行**: GASトリガーで定期的（推奨: 30分〜1時間ごと）に実行
- **手動実行**: 必要に応じて手動で実行可能

## 設定

### Script Properties

以下の設定をScript Propertiesに登録してください：

| Key | 説明 |
|---|---|
| `NOTION_API_TOKEN` | Notion API トークン |
| `NOTION_RELEASE_DB_ID` | リリースDBのID（`0cc4931427714c6bafe5f05bdc66ac22`） |
| `NOTION_ISSUE_DB_ID` | 全社共通Issue DBのID（`61b50f425ae14687b44ba250869f09ae`） |
| `NOTION_TASK_DB_ID` | 全社共通Task DBのID（`afafabe758044461a3e9e9b4c037e5aa`） |
| `NOTION_PRODUCT_DB_ID` | プロダクト DBのID（`0d0b0f9639454862af2b2c401f229ca6`） |
| `CALENDAR_ID` | GoogleカレンダーのID（デフォルトカレンダーの場合は空欄でも可） |

### 必要な権限

#### Notion API
- リリースDBの読み書き権限
- 全社共通Issue DBの読み取り権限
- 全社共通Task DBの読み取り権限
- プロダクト DBの読み取り権限

#### Google Calendar API
- カレンダーイベントの作成・更新権限
- イベントへの招待送信権限

## ディレクトリ構成

```
scripts/release_calendar_invite/
├── README.md                           # このファイル
├── release_calendar_invite.js          # メインスクリプト（実装予定）
├── test.js                             # テストスイート（実装予定）
└── docs/
    └── requirements.md                 # 要件定義書
```

## 処理フロー

### リリース日が入力されたとき

1. リリースDBからリリース日が設定されているリリースを取得
2. 各リリースについて、カレンダーイベントIDが未設定かチェック
3. 未設定の場合:
   - リリースに紐づく全社共通Issueを取得
   - 各全社共通Issueに紐づく全社共通Taskを取得
   - リリースに紐づくプロダクトを取得
   - スクラムマスターとTask担当者を抽出
   - NotionユーザーIDからメールアドレスに変換（マッピングファイル参照）
   - Googleカレンダーイベントを作成（リリース日の14:00）
   - イベントIDをリリースDBに保存

### リリース日が変更されたとき

1. リリースDBからリリース日が設定されているリリースを取得
2. 各リリースについて、カレンダーイベントIDが設定されているかチェック
3. 設定済みの場合:
   - 現在のイベントIDを取得
   - Google Calendarからイベントを取得
   - 現在のイベント日付とDBのリリース日を比較
   - 異なる場合、イベントの日付を新しいリリース日に更新（時間は維持）

## イベント内容

- **タイトル**: リリース名または「[プロダクト名] リリース」
- **時間**: リリース日の14:00（JST）、デフォルトで1時間のイベント
- **説明**: リリース情報へのNotionリンク、関連する全社共通Issueへのリンク
- **ゲスト**: プロダクトのスクラムマスター、全社共通Taskの担当者（重複排除）

**注意**: リリースDBには時間が入力されないため、デフォルトで14:00に設定されます。後でスクラムマスターが手動で適切な時間に変更する想定です。

## 使用方法

### 初回セットアップ

1. Script Propertiesに必要な設定を登録
2. ユーザー情報マッピングファイル（`docs/slack&notion_user_room_filtered.md`）の確認
3. GASトリガーを設定（推奨: 30分〜1時間ごと）
4. 動作確認のため手動実行

### 手動実行

```javascript
function manualRun() {
  main();
}
```

## ドキュメント

詳細な仕様は以下のドキュメントを参照してください：

- [要件定義書](./docs/requirements.md)

## 注意事項

- リリースの時間はリリースDBには入力されないため、デフォルトで14:00に設定されます
- メールアドレスが見つからないユーザーはスキップされ、ログに記録されます
- 実行頻度はAPIレート制限を考慮して設定してください

## 実装状況

- [x] 要件定義書作成
- [ ] メインスクリプト実装
- [ ] テストコード作成
- [ ] 動作確認

---

**作成日**: 2025年1月29日  
**バージョン**: 0.1（要件定義完了）

