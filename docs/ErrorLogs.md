# エラーログ記録

## 概要
タスク通知ボット実行時に発生したエラーとその原因、修正内容を記録します。

---

## ⚠️ 運用ルール（必須遵守）

### エラー発生時の記録義務
**エラーが発生した場合は、必ずこのドキュメントに以下を記録してください：**

1. **エラー概要**
   - 発生時刻
   - 対象プロジェクト/プロダクト
   - エラーコード
   - 影響範囲

2. **エラー詳細**
   - エラーログ（GASログからの抜粋）
   - 関連設定値（チャンネルID、ユーザーID等）

3. **原因分析**
   - エラーの性質（HTTPステータス、レスポンスボディ等）
   - 根本原因
   - 現在のコードの対応状況

4. **影響範囲**
   - どの処理に影響したか
   - 他の処理への影響はあるか

5. **暫定対応**
   - 発生時の暫定対応内容

6. **修正内容**（修正後）
   - 修正方針
   - 実装内容
   - 修正後の動作確認結果

### 記録フォーマット
各エラーは以下のフォーマットで記録してください：
```markdown
## YYYY/MM/DD HH:MM:SS - エラー名

### エラー概要
- **発生時刻**: [時刻]
- **対象**: [プロジェクト/プロダクト名]
- **エラーコード**: [コード]
- **影響範囲**: [影響の説明]

### エラー詳細
...

### 原因分析
...

### 影響範囲
...

### 暫定対応
...

### 修正内容
...
```

### 修正時は必ず更新
- エラーを修正した際は、該当エラーの「修正予定」セクションを「修正内容」に更新
- 「修正履歴」セクションに修正日時を追記
- コード変更と同時にドキュメントも更新すること

---

## 2025/10/27 10:05:59 - Slack通知channel_not_foundエラー

### エラー概要
- **発生時刻**: 2025/10/27 10:05:59（実行時間: 293.358秒）
- **対象プロジェクト**: Mukuge Phase 1 (PjM: 鈴木 遼)
- **エラーコード**: `200 - channel_not_found`
- **影響範囲**: 該当プロジェクトのSlack通知のみ失敗（他のプロジェクトは正常に処理）

### エラー詳細

#### エラーログ
```
2025/10/27 10:07:21	警告	Slack通知送信失敗 (試行1回目): 200 - channel_not_found
2025/10/27 10:07:21	警告	Slack通知送信失敗 (試行2回目): 200 - channel_not_found
2025/10/27 10:07:21	警告	Slack通知送信失敗 (試行3回目): 200 - channel_not_found
2025/10/27 10:07:21	エラー	Slack通知送信が最終的に失敗しました
```

#### プロジェクト設定
```javascript
'Mukuge Phase 1': { 
  channelId: 'C097UBAK886', 
  mentionUserId: 'U9ZFLRRG9', 
  notionId: '23e7d6b7-b8c6-8077-8c70-fdafbdda9aa3' 
}
```

### 原因分析

#### 1. エラーの性質
- **HTTPステータス**: 200（リクエスト自体は成功）
- **レスポンスボディ**: `{ "ok": false, "error": "channel_not_found" }`
- **Slack APIの仕様**: 特定のエラーパターンではHTTP 200を返すが、ボディにエラー情報を含む

#### 2. 根本原因
**チャンネルID `C097UBAK886` が存在しない、または削除されている**

考えられる原因：
1. チャンネルが削除された
2. チャンネルIDの設定ミス（タイポなど）
3. チャンネルがアーカイブされた
4. ワークスペースが変更された際にIDが変わった

#### 3. 現在のコードの対応状況
```javascript:scripts/task-notifier/task_notifier.js
// 1002-1007行目のリトライロジック
if (data.error === 'not_in_channel' && attempt < SLACK_API.RETRY_ATTEMPTS) {
  console.log('チャンネルに参加してからリトライします...');
  joinChannel(channelId);
  Utilities.sleep(SLACK_API.RETRY_DELAY_MS);
  continue;
}
```

**問題点**:
- `not_in_channel` エラーには自動join→リトライする処理がある
- `channel_not_found` エラーには対応していない
- チャンネルが存在しない場合は、3回リトライしても意味がない

### 影響範囲
- ✅ 他のプロジェクト通知: 正常に動作
- ❌ Mukuge Phase 1 の通知: 失敗
- ✅ エラー通知: 管理者（花輪）に正常に送信された
- ✅ 二重送信防止: 他のプロジェクトの通知成功により実行日が記録された

### 暫定対応
エラー通知が管理者に送信され、他のプロジェクトへの影響はなし。プロジェクト単体の通知失敗は確認済み。

### 修正予定
修正内容については別途記載予定。

---

## 解決完了（2025/10/27追記）

### 原因
- **チャンネルID**: `C097UBAK886` は正しい設定
- **URL**: https://playground-live.slack.com/archives/C097UBAK886
- **エラー原因**: プライベートチャンネルのため、Slackボットがアクセス権限を持っていない

### 解決方法
プライベートチャンネル `C097UBAK886` に手動でSlackアプリを追加する必要がある。

**手順**:
1. 該当チャンネルにアクセス
2. チャンネルのインテグレーション設定を開く
3. Slackアプリを追加

### 今後の改善案
- `channel_not_found` エラーに対してより詳細なエラーメッセージを送信
- プライベートチャンネルへの対応を明示的に案内

---

## エラー分類

### Slack関連エラー

#### channel_not_found
- **意味**: 指定されたチャンネルIDが存在しない
- **HTTPステータス**: 200
- **対応**: チャンネルIDの確認・修正が必要

#### not_in_channel
- **意味**: ボットがチャンネルに参加していない
- **HTTPステータス**: 200
- **対応**: 自動joinしてリトライ（実装済み）

---

## 修正履歴
- 2025/10/27: channel_not_foundエラー原因分析完了
